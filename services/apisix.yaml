# ==========================================
# apisix.yaml
# ==========================================

upstreams:
  - id: auth_service
    type: roundrobin
    nodes:
      "auth-service:5001": 1

  - id: matchmaking_service
    type: roundrobin
    nodes:
      "matchmaking-service:4000": 1

  - id: user_service
    type: roundrobin
    nodes:
      "user-service:5002": 1

routes:
  # Public route for login/register
  - id: auth_route
    uris:
      - /auth/*
    upstream_id: auth_service
    # plugins:
    #   proxy-rewrite:
    #     regex_uri: [ "^/api/auth/(.*)", "/auth/$1" ]

  # Protected route — requires JWT
  - id: matchmaking_route
    uris:
      - /api/matchmaking/*
    upstream_id: matchmaking_service
    plugins:
      jwt-auth:
        algorithm: HS256                 # ✅ Match your JWT signing algorithm (HS256, RS256, etc.)
        secret: "mysuperlongsharedsecretkey123456"            # ✅ Must match the secret used to sign JWTs
        header: Authorization             # ✅ Default, but you can change
        query: jwt                        # Optional: allow ?jwt=token
        cookie: jwt                       # Optional: allow cookies
#        validate_consumer: false
        claims_to_verify:
          - exp
          - nbf
      proxy-rewrite:
        regex_uri: [ "^/api/(.*)", "/$1" ]


  - id: user_route
    uris:
      - /api/users
      - /api/users/*
      - /api/leaderboard/*
    upstream_id: user_service
    plugins:
      jwt-auth:
        algorithm: HS256
        secret: "mysuperlongsharedsecretkey123456"
        header: Authorization
        query: jwt
        cookie: jwt
        claims_to_verify:
          - exp
          - nbf


consumers:
  - username: default
    plugins:
      jwt-auth:
        key: default
        secret: "mysuperlongsharedsecretkey123456"
#END