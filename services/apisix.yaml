# ==========================================
# apisix.yaml
# ==========================================

upstreams:
  - id: auth_service
    type: roundrobin
    nodes:
      "auth-service:5001": 1

  - id: matchmaking_service
    type: roundrobin
    nodes:
      "matchmaking-service:4000": 1

  - id: user_service
    type: roundrobin
    nodes:
      "user-service:5002": 1

routes:
  # Public route for login/register
  - id: auth_route
    uris:
      - /auth/*
    upstream_id: auth_service
    # plugins:
    #   proxy-rewrite:
    #     regex_uri: [ "^/api/auth/(.*)", "/auth/$1" ]

  # Protected route — requires JWT
  - id: matchmaking_route
    uris:
      - /api/matchmaking/*
    upstream_id: matchmaking_service
    plugins:
      jwt-auth:
        algorithm: HS256                 # ✅ Match your JWT signing algorithm (HS256, RS256, etc.)
        secret: ${{JWT_SECRET}}           # ✅ Must match the secret used to sign JWTs
        header: Authorization             # ✅ Default, but you can change
        query: jwt                        # Optional: allow ?jwt=token
        cookie: jwt                       # Optional: allow cookies
        store_in_ctx: true

        claims_to_verify:
          - exp
          - nbf
      serverless-pre-function:
        phase: "access" # Runs after authentication
        functions:
          - |
            return function(conf, ctx)
              -- 1. Import the APISIX core library
              local core = require("apisix.core")
            
              -- 2. Get the payload from the context
              local payload = ctx.jwt_auth_payload
            
              -- 3. Check if the payload exists
              if payload then
                -- 4. Set headers for the upstream service
                core.request.set_header(ctx, "X-UserID", payload.sub)
            
                -- 5. (Optional) Remove the original Authorization header
                core.request.set_header(ctx, "Authorization", nil)
              else
                -- Optional: Log an error if the payload is missing
                core.log.warn("jwt_auth_payload is missing from context")
              end
            end
      proxy-rewrite:
        regex_uri: [ "^/api/(.*)", "/$1" ]


  - id: user_route
    uris:
      - /api/users
      - /api/users/*
      - /api/leaderboard/*
    upstream_id: user_service
    plugins:
      jwt-auth:
        algorithm: HS256
        secret: ${{JWT_SECRET}}
        header: Authorization
        query: jwt
        cookie: jwt
        claims_to_verify:
          - exp
          - nbf

consumers:
  - username: default
    plugins:
      jwt-auth:
        key: default
        secret: ${{JWT_SECRET}}
        store_in_ctx: true
#END